const GITHUB_REPO="Lumingtianze/DoL-PWA",API_URL=`/api/proxy?url=${encodeURIComponent(`https://api.github.com/repos/${GITHUB_REPO}/releases/latest`)}`,PROXY_URL_TEMPLATE="/api/proxy?url={encoded_target_url}",GAME_CACHE_NAME="game-cache",LAUNCHER_CACHE_NAME="launcher-cache",HTML_KEY="game.html",IMG_ZIP_KEY="img.zip",META_KEY="meta.json";zip.configure({useWebWorkers:!1});const GAME_SCOPE="/play/",statusText=document.getElementById("status-text"),localVersionSpan=document.getElementById("local-version"),remoteVersionSpan=document.getElementById("remote-version"),modSelector=document.getElementById("mod-selector"),progressContainer=document.getElementById("progress-container"),progressLabel=document.getElementById("progress-label"),progressBar=document.getElementById("progress-bar"),actionBtn=document.getElementById("action-btn"),clearCacheBtn=document.getElementById("clear-cache-btn");let localMeta=null,latestReleaseData=null;document.addEventListener("DOMContentLoaded",main);async function main(){"serviceWorker"in navigator&&await navigator.serviceWorker.register("sw.js"),actionBtn.addEventListener("click",handleAction),clearCacheBtn.addEventListener("click",clearCache),modSelector.addEventListener("change",()=>{localStorage.setItem("selectedMod",modSelector.value),updateUI()}),await checkLocalCache(),updateUI(),checkRemoteVersions().then(()=>{updateUI()})}async function checkLocalCache(){statusText.textContent="\u68C0\u67E5\u672C\u5730\u6E38\u620F\u7248\u672C...";try{const e=await caches.open(GAME_CACHE_NAME),[n,t,o]=await Promise.all([e.match(META_KEY),e.match(HTML_KEY),e.match(IMG_ZIP_KEY)]);n&&t&&o?(localMeta=await n.json(),localVersionSpan.textContent=`${localMeta.tag} (${localMeta.shortName})`,clearCacheBtn.style.display="block",populateModSelectorWithLocal()):(localVersionSpan.textContent="\u65E0",localMeta=null,await caches.delete(GAME_CACHE_NAME))}catch(e){console.error("\u68C0\u67E5\u672C\u5730\u7F13\u5B58\u5931\u8D25:",e),localVersionSpan.textContent="\u8BFB\u53D6\u9519\u8BEF",localMeta=null}}async function clearCache(){if(confirm("\u786E\u5B9A\u8981\u6E05\u9664\u6240\u6709\u672C\u5730\u6570\u636E\u548C\u542F\u52A8\u5668\u7F13\u5B58\u5417\uFF1F\u6B64\u64CD\u4F5C\u5C06\u5F3A\u5236\u66F4\u65B0\u542F\u52A8\u5668\u672C\u8EAB\u3002")){if(statusText.textContent="\u6B63\u5728\u6E05\u9664\u6240\u6709\u7F13\u5B58\u548C\u670D\u52A1...",actionBtn.disabled=!0,clearCacheBtn.disabled=!0,"serviceWorker"in navigator){const e=await navigator.serviceWorker.getRegistrations();for(const n of e)await n.unregister()}await caches.delete(GAME_CACHE_NAME),await caches.delete(LAUNCHER_CACHE_NAME),window.location.reload()}}async function handleAction(){const e=actionBtn.textContent;e==="\u4E0B\u8F7D\u6E38\u620F"||e==="\u66F4\u65B0\u6E38\u620F"||e==="\u5207\u6362\u5E76\u4E0B\u8F7D"?await downloadAndCacheZip():e==="\u542F\u52A8\u6E38\u620F"?await launchGame():e==="\u91CD\u8BD5"&&(actionBtn.disabled=!0,statusText.textContent="\u6B63\u5728\u91CD\u65B0\u5C1D\u8BD5\u83B7\u53D6\u7248\u672C\u4FE1\u606F...",remoteVersionSpan.textContent="\u67E5\u8BE2\u4E2D...",await checkRemoteVersions(),updateUI())}async function downloadAndCacheZip(){actionBtn.disabled=!0,clearCacheBtn.disabled=!0,modSelector.disabled=!0,progressContainer.style.display="block";const e=modSelector.options[modSelector.selectedIndex],n={name:e.value,size:Number(e.dataset.size),shortName:e.textContent,targetUrl:e.dataset.url};try{const t=PROXY_URL_TEMPLATE.replace("{encoded_target_url}",encodeURIComponent(n.targetUrl)),a=await(await fetchWithProgress(t,n.size)).blob();progressLabel.textContent="\u4E0B\u8F7D\u5B8C\u6210\uFF0C\u6B63\u5728\u5904\u7406\u8D44\u6E90\u5305...";const s=new zip.ZipReader(new zip.BlobReader(a)),c=await s.getEntries(),l=c.find(u=>u.filename.endsWith(".html")),r=c.find(u=>u.filename==="img.zip");if(!l||!r)throw new Error("\u8D44\u6E90\u5305\u5185\u5BB9\u4E0D\u7B26\u5408\u9884\u671F (\u7F3A\u5C11 .html \u6216 img.zip)");const m=await l.getData(new zip.BlobWriter("text/html")),d=await r.getData(new zip.BlobWriter("application/zip")),i=await caches.open(GAME_CACHE_NAME);await i.put(HTML_KEY,new Response(m)),await i.put(IMG_ZIP_KEY,new Response(d));const p={tag:latestReleaseData.tag_name,assetName:n.name,shortName:n.shortName},h=new Response(JSON.stringify(p),{headers:{"Content-Type":"application/json"}});await i.put(META_KEY,h),await s.close(),statusText.textContent="\u6E38\u620F\u8D44\u6E90\u7F13\u5B58\u6210\u529F\uFF01",await checkLocalCache()}catch(t){console.error("\u4E0B\u8F7D\u6216\u7F13\u5B58\u5931\u8D25:",t),statusText.textContent=`\u64CD\u4F5C\u5931\u8D25: ${t.message}`,await caches.delete(GAME_CACHE_NAME),await checkLocalCache()}finally{progressContainer.style.display="none",actionBtn.disabled=!1,clearCacheBtn.disabled=!1,modSelector.disabled=!1,updateUI()}}async function launchGame(){statusText.textContent="\u6B63\u5728\u51C6\u5907\u6E38\u620F\u73AF\u5883...",actionBtn.disabled=!0;try{await navigator.serviceWorker.register("/sw-game.js",{scope:GAME_SCOPE}),await navigator.serviceWorker.ready,statusText.textContent="\u542F\u52A8\u6E38\u620F\u4E2D\uFF0C\u8BF7\u7A0D\u5019...",window.location.href=GAME_SCOPE}catch(e){console.error("\u542F\u52A8\u6E38\u620F\u5931\u8D25:",e),statusText.textContent=`\u542F\u52A8\u5931\u8D25: ${e.message}`,actionBtn.disabled=!1}}async function fetchWithProgress(e,n){const t=await fetch(e);if(!t.ok)throw new Error(`\u8BF7\u6C42\u5931\u8D25: ${t.statusText}`);if(!t.body)throw new Error("\u54CD\u5E94\u4E2D\u6CA1\u6709\u53EF\u8BFB\u7684 body \u5185\u5BB9\u3002");const o=n||Number(t.headers.get("content-length")||0);let a=0;const[s,c]=t.body.tee();return(async()=>{const l=s.getReader();for(;;)try{const{done:r,value:m}=await l.read();if(r)break;if(a+=m.length,o>0){const d=Math.round(a/o*100);progressBar.value=d;const i=(a/1024/1024).toFixed(1),p=(o/1024/1024).toFixed(1);progressLabel.textContent=`\u4E0B\u8F7D\u4E2D... ${i}MB / ${p}MB (${d}%)`}else progressLabel.textContent=`\u4E0B\u8F7D\u4E2D... ${(a/1024/1024).toFixed(1)}MB`}catch(r){console.error("\u8BFB\u53D6\u8FDB\u5EA6\u6D41\u65F6\u51FA\u9519:",r);break}})(),new Response(c,{headers:t.headers})}async function checkRemoteVersions(){try{const e=await fetch(API_URL);if(!e.ok)throw new Error(`API \u4EE3\u7406\u8BF7\u6C42\u5931\u8D25: ${e.statusText}`);latestReleaseData=await e.json();const n=latestReleaseData.assets.filter(t=>t.name.endsWith(".zip")&&!t.name.includes("polyfill"));if(n.length===0)throw new Error("\u5728\u6700\u65B0\u7684 Release \u4E2D\u672A\u627E\u5230\u4EFB\u4F55\u6E38\u620FZIP\u6587\u4EF6");populateModSelectorWithRemote(n),remoteVersionSpan.textContent=`${latestReleaseData.tag_name}`}catch(e){console.error("\u68C0\u67E5\u8FDC\u7A0B\u7248\u672C\u5931\u8D25:",e),statusText.textContent="\u83B7\u53D6\u7248\u672C\u5217\u8868\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u5E76\u91CD\u8BD5\u3002",remoteVersionSpan.textContent="\u83B7\u53D6\u5931\u8D25",latestReleaseData=null}}function populateModSelectorWithLocal(){if(!localMeta)return;modSelector.innerHTML="";const e=document.createElement("option");e.value=localMeta.assetName,e.textContent=localMeta.shortName,modSelector.appendChild(e),modSelector.disabled=!0}function populateModSelectorWithRemote(e){modSelector.innerHTML="",e.forEach(t=>{const o=document.createElement("option"),a=t.name.match(/Lyra-.*?-(.*)-\d{4}\.zip$/),s=a?a[1]:t.name;o.value=t.name,o.textContent=s,o.dataset.size=t.size,o.dataset.url=t.browser_download_url,modSelector.appendChild(o)});const n=localStorage.getItem("selectedMod");n&&modSelector.querySelector(`option[value="${n}"]`)&&(modSelector.value=n),modSelector.disabled=!1}function updateUI(){if(progressContainer.style.display==="block")return;const e=modSelector.options[modSelector.selectedIndex];if(localMeta)if(actionBtn.disabled=!1,latestReleaseData){const n=e?e.value:null;localMeta.assetName!==n?(actionBtn.textContent="\u5207\u6362\u5E76\u4E0B\u8F7D",statusText.textContent="\u9009\u62E9\u7684\u6A21\u7EC4\u4E0E\u672C\u5730\u7F13\u5B58\u4E0D\u4E00\u81F4\u3002"):localMeta.tag!==latestReleaseData.tag_name?(actionBtn.textContent="\u66F4\u65B0\u6E38\u620F",statusText.textContent=`\u53D1\u73B0\u65B0\u7248\u672C ${latestReleaseData.tag_name}\uFF0C\u53EF\u8FDB\u884C\u66F4\u65B0\u3002`):(actionBtn.textContent="\u542F\u52A8\u6E38\u620F",statusText.textContent="\u6E38\u620F\u5DF2\u662F\u6700\u65B0\u7248\u672C\uFF0C\u53EF\u4EE5\u542F\u52A8\u3002")}else actionBtn.textContent="\u542F\u52A8\u6E38\u620F",statusText.textContent="\u53EF\u79BB\u7EBF\u542F\u52A8\u6E38\u620F\u3002";else latestReleaseData?(actionBtn.textContent="\u4E0B\u8F7D\u6E38\u620F",actionBtn.disabled=!1,statusText.textContent="\u5C1A\u672A\u4E0B\u8F7D\u6E38\u620F\uFF0C\u8BF7\u9009\u62E9\u4E00\u4E2A\u6A21\u7EC4\u8FDB\u884C\u4E0B\u8F7D\u3002"):(actionBtn.textContent="\u91CD\u8BD5",actionBtn.disabled=!1,statusText.textContent="\u83B7\u53D6\u7248\u672C\u5217\u8868\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u5E76\u91CD\u8BD5\u3002")}
